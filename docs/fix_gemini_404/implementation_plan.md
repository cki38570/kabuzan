# Gemini API 404 エラー解決およびモデル自動選定の実装計画

`gemini-1.5-flash` モデルが見つからないというエラーを解消し、環境に合わせた最適なモデルを自動的に選択する仕組みを導入します。

## ユーザーレビューが必要な事項
- **APIキーの権限**: 万が一、すべてのモデルで 404 が発生する場合、APIキー自体の権限や有効期限に依存している可能性がありますが、本修正では「名前の不整合」を最優先で解決します。

## 変更内容

### 1. マルチモデル・フォールバックの実装

#### [MODIFY] [llm.py](file:///c:/Users/GORO/Desktop/kabuzan/modules/llm.py)
- **モデル試行リストの導入**: `'gemini-1.5-flash'`, `'gemini-1.5-flash-latest'`, `'gemini-1.5-flash-001'`, `'gemini-2.0-flash-exp'` などのリストを順に試行するループを実装します。
- **デバッグ情報の強化**: 各モデルの呼び出しに失敗した際、どのモデル名でどのようなエラーが返ったかを具体的にログ出力するようにし、原因の切り分けを確実に行います。
- **V1/Legacy 両SDKの共通化**: モデル試行ロジックを共通化し、どちらのSDKでも最適なモデルを見つけられるようにします。

### 2. 環境チェック機能の追加

#### [NEW] [test_gemini.py](file:///c:/Users/GORO/Desktop/kabuzan/tests/test_gemini.py)
- シンプルなプロンプトを投げて、利用可能なモデル名を特定するデバッグ用スクリプトを作成します。これを実行することで、環境に最適な設定を一発で特定できます。

## 検証計画

### 自動テスト
- `tests/test_gemini.py` を実行し、Streamlit Cloud 上でモデルが正常にメッセージを返すことを確認。

### 手動検証
1. 修正後のアプリで「AI分析」を実行し、以前の「404 NOT_FOUND」が表示されず、分析レポートが表示されることを確認。
2. 内部ログ（Streamlit の Console）を確認し、最終的にどのモデル名で成功したかを把握。
