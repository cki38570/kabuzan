# 実装計画 - サイドバーのインデント修正とUIの堅牢化 (継続)

サイドバーの `add_ticker_form` ブロックとウォッチリスト描画ロジックの分離を確実に行い、`st.button` がフォーム内で使用されることによるエラーを防ぎます。また、銘柄情報取得に失敗した場合の数値計算エラーを防止するための堅牢化を行います。

## ユーザーレビューが必要な項目

> [!NOTE]
> すでに前回の作業で `app.py` のインデントは修正されているように見えますが、再確認を行い、念のため `get_cached_card_info` のエラーハンドリングを強化します。

## 提案される変更

### [Component: UI & Logic]

#### [MODIFY] [app.py](file:///c:/Users/GORO/Desktop/kabuzan/app.py)
- `get_cached_card_info` 関数内で、`curr` や `prev` が `None` の場合に 0 に倒すだけでなく、可能な限り代替値（history からの値）を使用するようにロジックを整理します。
- `st.form` の外にウォッチリスト描画があることを再確認し、インデントのズレがないか徹底チェックします。
- `render_stock_card` 呼び出し時の引数チェックを追加し、不正な値で落ちないようにします。

## 検証計画

### 自動検証
- `python -m py_compile app.py` で構文エラーがないことを確認。

### 手動検証（ブラウザツールを使用）
1. アプリを起動し、サイドバーが表示されることを確認。
2. 銘柄を追加し、ウォッチリストに正常に並ぶことを確認.
3. ウォッチリストの各銘柄（ボタン）をクリックし、メイン画面が更新されることを確認。
4. 「リストをクリア」ボタンが正常に動作することを確認。
5. ネットワークエラー等を模した状況（あるいは不正なティッカー）でも、アプリがクラッシュせずに「0」や「読み込み失敗」と表示されることを確認。
