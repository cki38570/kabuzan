# 実装計画: ポートフォリオ追加機能の不具合修正

ポートフォリオ追加時にデータが保存されない不具合と、ページがリセットされて入力の手間が発生する問題を修正します。

## 問題の分析
1. **保存の失敗**: `modules/storage.py` の `save_portfolio` が失敗してもエラーが表示されず、成功したかのように振る舞っている。
2. **状態の喪失**: `st.rerun()` によってページ全体がリセット（スクロール位置やタブ選択の初期化）され、特定の条件下で `active_ticker` が失われている可能性がある。
3. **ユーザビリティ**: 保存の成否が不明確なままリロードされるため、ユーザーが混乱している。

## 提案する変更

### 1. `modules/storage.py` の改善
- 保存処理に詳細なエラーログと例外処理を追加する。
- 保存が成功したかどうかを確実に呼び出し元に伝える。

### 2. `modules/portfolio.py` の改善
- `add_to_portfolio` が保存の成否（boolean値）を返すように変更する。

### 3. `app.py` の改善
- ポートフォリオ追加時の成否判定に基づき、成功時のみ `st.success` を表示し、失敗時は `st.error` を表示する。
- ページリセット前に、`st.session_state` の状態が正しく同期されているか確認する。
- （オプション）タブの選択状態を保持できるように、`st.session_state` を活用したタブ管理（または通知の改善）を検討する。

## 変更ファイル

### [MODIFY] [storage.py](file:///c:/Users/GORO/Desktop/kabuzan/modules/storage.py)
- `save_portfolio` および `save_watchlist` に例外のキャッチとログ出力を追加。
- `streamlit` モードでの接続エラー時の詳細情報を取得するように改善。

### [MODIFY] [portfolio.py](file:///c:/Users/GORO/Desktop/kabuzan/modules/portfolio.py)
- `add_to_portfolio` および `save_portfolio` ラッパーが成否を返すように修正。

### [MODIFY] [app.py](file:///c:/Users/GORO/Desktop/kabuzan/app.py)
- ポートフォリオ追加フォームの処理ロジックを修正。

## 検証プラン

### 自動テスト
- 現状、スプレッドシートへの接続が必要なため、単体テストは困難。モックを使用した保存処理のテストを検討。

### 手動検証
1. ポートフォリオに銘柄を追加し、スプレッドシート（またはローカルJSON）に正しく反映されるか確認。
2. 保存失敗時に適切なエラーメッセージが表示されるか確認。
3. 追加後に `active_ticker` が維持されているか（検索バーにコードが残っているか）確認。
4. 以前より「何度も銘柄コードを入力する手間」が軽減されているか確認。
