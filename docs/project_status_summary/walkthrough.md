# kabuzan 現状整理レポート (Walkthrough)

「kabuzan」の全ファイルをスキャンし、現在のシステム構成、各モジュールの役割、データ管理手法、および実装済み機能をまとめました。

## 1. アプリの現在の全体的なシステム構成

「kabuzan」は、**Streamlit** をフロントエンド基盤とし、**yfinance** および **DefeatBeta API** から取得した市場データを、**Gemini (AI)** で高度に分析する株価分析プラットフォームです。

### アーキテクチャの概要
- **メインUI層**: `app.py` がサイドバー、タブ、メインコンテンツの表示を制御。
- **データ・ロジック層**: `modules/data_manager.py` が複数のデータソースを統合管理。
- **分析層**: `modules/analysis.py` (テクニカル) と `modules/llm.py` (AI) が協力して投資判断を生成。
- **永続化層**: `modules/storage.py` が環境（ローカル/クラウド）に応じて保存先を動的に切り替え。
- **通知層**: `modules/notifications.py` が LINE Messaging API を通じてアラートやレポートを配信。

---

## 2. 各モジュールの具体的な役割

| モジュール名 | 役割 |
| :--- | :--- |
| `app.py` | アプリのエントリポイント。ページ管理、ユーザー入力の処理、各タブのレンダリング。 |
| `analysis.py` | テクニカル指標（SMA, RSI, MACD, BB）の計算、売買戦略（指値・損切レベル）の策定、**信用残データの解析**。 |
| `llm.py` | Gemini APIを利用した高度な分析。プロンプト構築、**Self-Reflection（対話型思考）**の実行。 |
| `data_manager.py` | データの司令塔。yfinance (Live) / キャッシュ / Fallbackデータを使い分けて可用性を担保。 |
| `storage.py` | ウォッチリスト、ポートフォリオ、設定情報の保存。**JSONファイル**または**Google Sheets**を制御。 |
| `notifications.py` | **LINE通知**のロジック。定期レポートの作成、価格/テクニカルアラートの判定と送信。 |
| `charts.py` | 軽量チャート（Lightweight Charts）や信用残バーチャートの生成。 |
| `backtest.py` | 過去30日間の価格データを用いた戦略のバックテストと勝率計算。 |

---

## 3. データの保存先と管理方法

データは `modules/storage.py` を通じて以下の3つの方法で管理されています：

1.  **ローカル環境**: `watchlist.json`, `portfolio.json`, `settings.json` 等に保存。
2.  **Streamlit Cloud**: 接続情報があれば **Google Sheets** に保存され、ブラウザやデバイスを跨いで同期。
3.  **GitHub Actions (自動監視モード)**: 環境変数 `GCP_SERVICE_ACCOUNT_KEY` を用いて、Headlessモードで Google Sheets を直接更新。

---

## 4. 「これ、もう入ってる？」チェックリスト ✅

ご質問いただいた機能の実装状況を確認しました：

- **信用残（需給）の分析機能**
    - **[実装済み]**: `modules/analysis.py` の `generate_ai_report` (L327) および `app.py` (L502) にて、信用倍率の取得と「信用残推移」のチャート表示が実装されています。
- **AI（Gemini）の「Self-Reflection（強気・弱気派の対話）」**
    - **[実装済み]**: `modules/llm.py` のプロンプト (L96) にて、強気派 (Bull) と弱気派 (Bear) の視点から議論させるタスクが定義されています。
- **LINE通知の仕組み**
    - **[実装済み]**: `modules/line.py` および `notifications.py` にて、Messaging APIを用いたプッシュ通知が動作可能です。設定画面からON/OFFを切り替えられます。
- **データ永続化**
    - **[実装済み]**: `storage.py` により、JSONまたはSheetsへ保存されるため、ブラウザを閉じてもウォッチリストや設定は保持されます。

---

## 5. 「次にやるべきこと」とTODO 🚀

AIの視点から見た、現在のコードの課題と改善案です：

### 未完成・改善が必要な部分
1.  **マーケットスキャンの並列化**: `modules/screener.py` で多くの銘柄をスキャンする際、現在は順次処理のため時間がかかります。`concurrent.futures` 等を用いた並列処理がTODOとして残っています。
2.  **エラーハンドリングの強化**: `yfinance` のレート制限 (`YFRateLimitError`) への対応は強化されましたが、より堅牢なリトライロジックの追加が検討の余地ありです。
3.  **リアルタイム性の向上**: 現在は5分キャッシュ等が中心ですが、Websocket等を用いた本当のリアルタイム更新はまだ組まれていません。

### 投資判断の精度向上に向けた提案
- **マクロデータの統合**: 現在は日経平均指数のみですが、米金利やドル円などの外部変数をもっと具体的にAIに読み込ませることで、より「正確な売り買いのタイミング」を提示できる可能性があります。
- **マルチタイムフレーム分析の強化**: 週足・日足の組み合わせは入っていますが、4時間足などの短いスパンを組み合わせることで、エントリーの精度を高めることができます。

---
以上が現在の「kabuzan」の全容です。
